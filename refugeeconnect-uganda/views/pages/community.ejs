<!-- views/pages/community.ejs -->
<h1 class="mb-4">Community</h1>

<div class="row">
  <div class="col-md-4 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Community Groups</h5>
      </div>
      <div class="card-body" id="groupsContainer">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-8 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Community Messages</h5>
      </div>
      <div class="card-body">
        <div id="messagesContainer" style="max-height: 500px; overflow-y: auto;">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <form id="messageForm" class="d-flex gap-2">
            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
            <button type="submit" class="btn btn-primary">Send</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

async function loadGroups() {
  try {
    const response = await fetch('/api/community/groups');
    const data = await response.json();
    const container = document.getElementById('groupsContainer');
    
    if (data.success && data.groups.length > 0) {
      container.innerHTML = data.groups.map(group => `
        <div class="card mb-2">
          <div class="card-body">
            <h6>${group.name}</h6>
            <p class="small text-muted">${group.description}</p>
            <p class="small"><strong>Members:</strong> ${group.members}</p>
            <button class="btn btn-sm btn-primary" onclick="joinGroup(${group.id})">Join</button>
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = '<p class="text-muted">No groups available.</p>';
    }
  } catch (error) {
    console.error('Error loading groups:', error);
  }
}

async function loadMessages() {
  try {
    const response = await fetch('/api/community/messages');
    const data = await response.json();
    const container = document.getElementById('messagesContainer');
    
    if (data.success && data.messages.length > 0) {
      container.innerHTML = data.messages.map(msg => `
        <div class="mb-3">
          <strong>${msg.userName}:</strong> ${msg.message}
          <br><small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    } else {
      container.innerHTML = '<p class="text-muted">No messages yet. Be the first to post!</p>';
    }
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}

async function joinGroup(groupId) {
  try {
    const response = await fetch(`/api/community/groups/${groupId}/join`, {
      method: 'POST'
    });
    const data = await response.json();
    if (data.success) {
      alert('Successfully joined group!');
      loadGroups();
    }
  } catch (error) {
    console.error('Error joining group:', error);
  }
}

document.getElementById('messageForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const message = document.getElementById('messageInput').value;
  if (!message.trim()) return;
  
  try {
    const response = await fetch('/api/community/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const data = await response.json();
    if (data.success) {
      document.getElementById('messageInput').value = '';
      loadMessages();
    }
  } catch (error) {
    console.error('Error sending message:', error);
  }
});

socket.on('new-message', () => {
  loadMessages();
});

loadGroups();
loadMessages();
</script>
